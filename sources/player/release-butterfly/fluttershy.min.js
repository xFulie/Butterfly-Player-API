const Kernel = new Blueberry()

const Player = new class {

	colorPlayer = "#fff"
	colorPlayerText = "#000"

	link_css_player = '//floagg.info/package/beta-stylesheet@v0.3-fluttershy'

	videoSrc = ''

	playerTitle = 'Vous regardez'
	playerSubTitle = ''

	intro_skipping = null

	set(tags_contenaire_for_player, setting_obj) {
		Kernel.gContenaire = tags_contenaire_for_player
		this.userSet = setting_obj
		

		if(this.userSet.init) {
			Kernel.vSrc = this.userSet.init
			this.videoSrc = this.userSet.init
		}

		/// INIT LISTE
		if(this.userSet.quality) {
			Kernel.vAllQuality = this.userSet.quality
		}
		if(this.userSet.subtitle) {
			Kernel.vAllSubtitle = this.userSet.subtitle
		}
		if(this.userSet.audio) {
			Kernel.vAllAudio = this.userSet.audio

			let i = 0;
			this.userSet.audio.forEach((e) => {
				this.userSet.audio[i].src = e.init
				i++
			})

			if(!this.videoSrc) {
				this.videoSrc = this.userSet.audio[0].init
				this.videoSrc = this.userSet.audio[0].init+Kernel.vCurrentQuality+"."+Kernel.vCurrentExtension
				Kernel.vSrc = this.videoSrc
			}
		}


		// tmp
		if(this.userSet.extension && this.userSet.extension[0]) {
			Kernel.vAllExtension = this.userSet.extension
		}
		// tmp


		/// INIT
		if(this.userSet.defaultQuality) {
			Kernel.vCurrentQuality = this.userSet.defaultQuality
		}

		if(this.userSet.thumbnail) {
			Kernel.vThumbnail = this.userSet.thumbnail
		}
		if(this.userSet.height && this.userSet.width) {
			Kernel.gSize([this.userSet.height, this.userSet.width])
		}

		Kernel.onChangeQuality = () => {
			this.videoSrc = this.videoSrc+Kernel.vCurrentQuality+"."+Kernel.vCurrentExtension
			Kernel.vSrc = this.videoSrc
		}

		Kernel.onChangeAudio = (e) => {
			this.videoSrc = e
			Kernel.vSrc = this.videoSrc+Kernel.vCurrentQuality+"."+Kernel.vCurrentExtension
			console.log( Kernel.vSrc)
		}


		Kernel.onTimeUpdate = () => {
			if(
				(Kernel.vCurrentTime > this.intro_skipping[0])
				&&
				(Kernel.vCurrentTime < this.intro_skipping[1])
			) {
				Kernel.gClassRemove('player-button-is-skipped')
			} else {
				Kernel.gClassAdd('player-button-is-skipped')
			}
		}



		// Player Others
		if(this.userSet.title) {
			this.playerTitle = this.userSet.title
		}

		if(this.userSet.sub_title) {
			this.playerSubTitle = this.userSet.sub_title
		}

		if(this.userSet.intro_skipping) {
			this.intro_skipping = this.userSet.intro_skipping
		}
		
	}

	load() {
		document.querySelector('head').insertAdjacentHTML(
			'beforeend',
			`<style type="text/css">:root { --color-primary-player-butterfly: ${this.colorPlayer}; --color-text-player-butterfly: ${this.colorPlayerText}; }</style>`
		)
		document.querySelector('head').insertAdjacentHTML(
			'beforeend',
			`<link rel="stylesheet" type="text/css" href="${this.link_css_player}">`
		)

		Kernel.init()

		let html = `<div class="info_file">`
			html += `<h2>${this.playerSubTitle}</h2>`
			html += `<h1 id="filename">${this.playerTitle}</h1>`
		html += `</div>`

		if(this.intro_skipping)
			Kernel.gAdding('beforeend', `<div class="player-button"><a id="skip_intro_video">Passer l'introduction</a></div>`, '')

		Kernel.gAdding('beforeend', html, '.butterfly-player-controleurs .top')
	}

	plugin() {
		console.error('Player.plugin() n\'existe plus dans la nouvelle versions')
	}
}