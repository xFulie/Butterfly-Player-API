class Fluttershy {

	Kernel = new Blueberry()

	colorPlayer = "#fff"
	colorPlayerText = "#000"

	link_css_player = '//floagg.info/package/beta-stylesheet@v0.3-fluttershy'

	videoSrc = ''

	playerTitle = 'Vous regardez'
	playerSubTitle = ''

	intro_skipping = null

	set(tags_contenaire_for_player, setting_obj) {
		this.Kernel.gContenaire = tags_contenaire_for_player
		this.userSet = setting_obj
		

		if(this.userSet.src !== undefined) {
			this.Kernel.vSrc = this.userSet.src
			this.videoSrc = this.userSet.src
		}

		/// INIT LISTE
		if(this.userSet.quality !== undefined) {
			this.Kernel.vAllQuality = this.userSet.quality
		}
		if(this.userSet.subtitle !== undefined) {
			this.Kernel.vAllSubtitle = this.userSet.subtitle
		}
		if(this.userSet.audio !== undefined) {
			this.Kernel.vAllAudio = this.userSet.audio

			if(!this.videoSrc) {
				this.videoSrc = this.userSet.audio[0].src
				let reg = this.userSet.audio[0].src
					.replace(/\$\(\{audio\}\)/g, this.userSet.audio[0].src)
					.replace(/\$\(\{quality\}\)/g, this.Kernel.vCurrentQuality)
					.replace(/\$\(\{extension\}\)/g, this.Kernel.vCurrentExtension)
				this.Kernel.vSrc = reg
			}
		}


		// tmp
		if(this.userSet.extension && this.userSet.extension[0]) {
			this.Kernel.vAllExtension = this.userSet.extension
		}
		// tmp


		/// INIT
		if(this.userSet.defaultQuality !== undefined) {
			this.Kernel.vCurrentQuality = this.userSet.defaultQuality
		}

		if(this.userSet.thumbnail !== undefined) {
			this.Kernel.vThumbnail = this.userSet.thumbnail
		}
		if(this.userSet.height && this.userSet.width) {
			this.Kernel.gSize = [this.userSet.height, this.userSet.width]
		}


		if(this.userSet.volume !== undefined) {
			this.Kernel.vVolume = this.userSet.volume
		}

		if(this.userSet.controls !== undefined) {
			this.Kernel.vControls = this.userSet.controls
		} else {
			this.userSet.controls = true;
		}


		this.Kernel.onChangeQuality = () => {
			let reg = this.videoSrc
				.replace(/\$\(\{audio\}\)/g, this.videoSrc)
				.replace(/\$\(\{quality\}\)/g, this.Kernel.vCurrentQuality)
				.replace(/\$\(\{extension\}\)/g, this.Kernel.vCurrentExtension)
				
			this.Kernel.vSrc = reg
		}

		this.Kernel.onChangeAudio = (e) => {
			this.videoSrc = e

			let reg = this.videoSrc
				.replace(/\$\(\{audio\}\)/g, this.videoSrc)
				.replace(/\$\(\{quality\}\)/g, this.Kernel.vCurrentQuality)
				.replace(/\$\(\{extension\}\)/g, this.Kernel.vCurrentExtension)
				
			this.Kernel.vSrc = reg
		}



		// Player Others
		if(this.userSet.title) {
			this.playerTitle = this.userSet.title
		}

		if(this.userSet.sub_title) {
			this.playerSubTitle = this.userSet.sub_title
		}

		if(this.userSet.intro_skipping) {
			this.intro_skipping = this.userSet.intro_skipping

			this.Kernel.onTimeUpdate = () => {
				if(
					(this.Kernel.vCurrentTime > this.intro_skipping[0])
					&&
					(this.Kernel.vCurrentTime < this.intro_skipping[1])
				) {
					this.Kernel.gClassRemove('player-button-is-skipped')
				} else {
					this.Kernel.gClassAdd('player-button-is-skipped')
				}
			}
		}
		
	}

	load() {
		document.querySelector('head').insertAdjacentHTML(
			'beforeend',
			`<style type="text/css">:root { --color-primary-player-butterfly: ${this.colorPlayer}; --color-text-player-butterfly: ${this.colorPlayerText}; }</style>`
		)
		document.querySelector('head').insertAdjacentHTML(
			'beforeend',
			`<link rel="stylesheet" type="text/css" href="${this.link_css_player}">`
		)

		this.Kernel.init()
		if(!this.userSet.controls)
			return;

		let html = `<div class="info_file">`
			html += `<h2>${this.playerSubTitle}</h2>`
			html += `<h1 id="filename">${this.playerTitle}</h1>`
		html += `</div>`
		this.Kernel.gAdding('beforeend', html, '.butterfly-player-controleurs .top')

		if(this.intro_skipping) {
			this.Kernel.addingContenaire = `<div class="player-button"><a id="skip_intro_video">Passer l'introduction</a></div>`;

			this.Kernel.addEvent('#skip_intro_video', 'click', () => {
				this.Kernel.vCurrentTime = this.intro_skipping[1]
			}, true)
		}
	}
}

const Player = new Fluttershy()